<div class="p-6 lg:p-8 space-y-8">
    <header class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-2">
            <p class="text-sm font-semibold text-indigo-600 uppercase tracking-tight">Administración</p>
            <h1 class="text-3xl font-bold text-gray-900">Panel administrativo</h1>
            <p class="text-sm text-gray-500">Supervisa el pulso general de la operación y genera reportes ejecutivos.</p>
            <p class="text-xs text-gray-400">Última actualización: {{ ultimaActualizacion() ? (ultimaActualizacion() | date:'short') : '—' }}</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button type="button" class="btn-secondary" (click)="refrescar()">
                Actualizar
            </button>
            <a class="btn-primary" routerLink="/admin/usuarios">
                Gestionar usuarios
            </a>
        </div>
    </header>

    <section *ngIf="loading()" class="space-y-4">
        <div class="skeleton h-28"></div>
        <div class="skeleton h-56"></div>
        <div class="skeleton h-48"></div>
    </section>

    <section *ngIf="!loading() && error()" class="alert-error">
        {{ error() }}
    </section>

    <ng-container *ngIf="!loading() && !error()">
        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <article class="stat-card">
                <p class="stat-label">Ventas del mes</p>
                <p class="stat-value">{{ formatearMoneda(resumen()?.ventasMes) }}</p>
                <span class="stat-variation" [ngClass]="variacionClase(resumen()?.variacionVentas)">
                    {{ variacionEtiqueta(resumen()?.variacionVentas) }}
                </span>
            </article>
            <article class="stat-card">
                <p class="stat-label">Órdenes activas</p>
                <p class="stat-value">{{ formatearNumero(resumen()?.ordenesActivas) }}</p>
                <span class="stat-variation" [ngClass]="variacionClase(resumen()?.variacionOrdenes)">
                    {{ variacionEtiqueta(resumen()?.variacionOrdenes) }}
                </span>
            </article>
            <article class="stat-card">
                <p class="stat-label">Productos bajo stock</p>
                <p class="stat-value">{{ formatearNumero(resumen()?.productosBajoStock) }}</p>
                <span class="stat-variation" [ngClass]="variacionClase(resumen()?.variacionStock)">
                    {{ variacionEtiqueta(resumen()?.variacionStock) }}
                </span>
            </article>
            <article class="stat-card">
                <p class="stat-label">Nuevos clientes</p>
                <p class="stat-value">{{ formatearNumero(resumen()?.nuevosClientes) }}</p>
                <span class="stat-variation" [ngClass]="variacionClase(resumen()?.variacionClientes)">
                    {{ variacionEtiqueta(resumen()?.variacionClientes) }}
                </span>
            </article>
        </section>

        <section class="panel">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-tight">Tendencias</p>
                    <h2 class="text-2xl font-semibold text-gray-900">Desempeño consolidado</h2>
                    <p class="text-sm text-gray-500">Seguimiento de ventas, órdenes e indicadores financieros.</p>
                </div>
                <label class="text-sm text-gray-600 space-y-1">
                    Periodo
                    <select class="input" [value]="periodo()" (change)="cambiarPeriodo($any($event.target).value)">
                        <option *ngFor="let opcion of periodosDisponibles" [value]="opcion.valor">{{ opcion.etiqueta }}</option>
                    </select>
                </label>
            </div>

            <div *ngIf="tendenciasCargando()" class="space-y-3">
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
            </div>

            <div *ngIf="!tendenciasCargando() && tendenciasError()" class="alert-error">
                {{ tendenciasError() }}
            </div>

            <div *ngIf="!tendenciasCargando() && !tendenciasError() && tendencias().length === 0" class="empty-state">
                No hay datos suficientes para el periodo seleccionado.
            </div>

            <div *ngIf="!tendenciasCargando() && !tendenciasError() && tendencias().length > 0" class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-500">
                            <th class="px-4 py-2 font-medium">Periodo</th>
                            <th class="px-4 py-2 font-medium">Ventas</th>
                            <th class="px-4 py-2 font-medium">Órdenes</th>
                            <th class="px-4 py-2 font-medium">Ingresos</th>
                            <th class="px-4 py-2 font-medium">Egresos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let tendencia of tendencias(); trackBy: trackByTendencia" class="border-t border-gray-100">
                            <td class="px-4 py-3 font-medium text-gray-900">{{ tendencia.periodo }}</td>
                            <td class="px-4 py-3">{{ formatearNumero(tendencia.ventas) }}</td>
                            <td class="px-4 py-3">{{ formatearNumero(tendencia.ordenes) }}</td>
                            <td class="px-4 py-3">{{ formatearMoneda(tendencia.ingresos) }}</td>
                            <td class="px-4 py-3">{{ formatearMoneda(tendencia.egresos) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-tight">Monitoreo</p>
                    <h2 class="text-2xl font-semibold text-gray-900">Alertas críticas</h2>
                    <p class="text-sm text-gray-500">Se muestran las últimas incidencias reportadas por los módulos.</p>
                </div>
                <span class="badge">{{ alertas().length }} activas</span>
            </div>

            <div *ngIf="alertasVisibles().length === 0" class="empty-state">
                No se registran alertas en este momento.
            </div>

            <ul *ngIf="alertasVisibles().length > 0" class="space-y-3">
                <li *ngFor="let alerta of alertasVisibles(); trackBy: trackByAlerta" class="alert-card">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-tight">{{ alerta.modulo }}</p>
                        <p class="text-base font-semibold text-gray-900">{{ alerta.mensaje }}</p>
                        <p class="text-sm text-gray-500">{{ alerta.tipo }}</p>
                    </div>
                    <div class="text-right space-y-1">
                        <span class="chip" [ngClass]="alertaClase(alerta.criticidad)">{{ alerta.criticidad | titlecase }}</span>
                        <p class="text-xs text-gray-500">{{ alerta.fecha | date:'short' }}</p>
                    </div>
                </li>
            </ul>
        </section>

        <section class="panel space-y-6">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-tight">Reportes</p>
                    <h2 class="text-2xl font-semibold text-gray-900">Generador ejecutivo</h2>
                    <p class="text-sm text-gray-500">Descarga reportes consolidados con los filtros deseados.</p>
                </div>
                <span class="text-sm text-gray-500">{{ plantillas().length }} plantillas disponibles</span>
            </div>

            <form class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" [formGroup]="form" (ngSubmit)="generarReporte()">
                <label class="field">
                    <span>Tipo de reporte</span>
                    <select class="input" formControlName="plantilla" [disabled]="plantillas().length === 0">
                        <option [ngValue]="null" disabled>Selecciona una opción</option>
                        <option *ngFor="let plantilla of plantillas()" [ngValue]="plantilla.id">{{ plantilla.nombre }}</option>
                    </select>
                </label>

                <label class="field">
                    <span>Formato</span>
                    <select class="input" formControlName="formato" [disabled]="!plantillaSeleccionada()">
                        <option *ngFor="let formato of formatosDisponibles()" [value]="formato">{{ formato | uppercase }}</option>
                    </select>
                </label>

                <label class="field">
                    <span>Fecha inicio</span>
                    <input class="input" type="date" formControlName="fechaInicio">
                </label>

                <label class="field">
                    <span>Fecha fin</span>
                    <input class="input" type="date" formControlName="fechaFin">
                </label>

                <label class="field md:col-span-2">
                    <span class="flex items-center gap-2">
                        <input type="checkbox" formControlName="incluirDetalles" class="accent-indigo-600">
                        Incluir detalles de movimientos
                    </span>
                </label>

                <div class="md:col-span-2 flex flex-wrap gap-3">
                    <button type="submit" class="btn-primary" [disabled]="generando() || plantillas().length === 0">
                        {{ generando() ? 'Generando...' : 'Generar y exportar' }}
                    </button>
                    <button type="button" class="btn-secondary" (click)="limpiarFechas()">
                        Limpiar fechas
                    </button>
                </div>
            </form>

            <div *ngIf="exportError()" class="alert-error">
                {{ exportError() }}
            </div>
        </section>
    </ng-container>
</div>