<div class="p-6 lg:p-8 grid grid-cols-1 xl:grid-cols-3 gap-8">
    <section class="xl:col-span-2 space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <p class="text-sm font-semibold text-blue-600 uppercase tracking-tight">Salidas</p>
                <h1 class="text-3xl font-bold text-gray-900">Registrar nueva venta</h1>
                <p class="text-gray-500">Selecciona los productos, define la información del cliente y genera la factura.</p>
            </div>
            <div class="flex gap-3">
                <a routerLink="/salidas" class="px-4 py-2 rounded-xl border border-gray-200 text-gray-700 font-medium hover:border-gray-300">Historial de ventas</a>
                <a routerLink="/salidas/clientes" class="px-4 py-2 rounded-xl border border-gray-200 text-gray-700 font-medium hover:border-gray-300">Gestión de clientes</a>
            </div>
        </div>

        <article class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Catálogo disponible</h2>
                    <p class="text-sm text-gray-500">Busca por nombre o código para agregar productos rápidamente.</p>
                </div>
                <input
                    type="search"
                    placeholder="Buscar producto para agregar..."
                      class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                    [value]="busqueda()"
                    (input)="actualizarBusqueda($any($event.target).value)"
                >
            </div>

            <div *ngIf="loadingCatalogo()" class="space-y-3">
                <div class="animate-pulse h-16 rounded-xl bg-gray-100"></div>
                <div class="animate-pulse h-16 rounded-xl bg-gray-100"></div>
            </div>

            <div *ngIf="!loadingCatalogo() && catalogoError()" class="p-4 bg-red-50 text-red-700 rounded-xl">
                {{ catalogoError() }}
            </div>

            <div *ngIf="!loadingCatalogo() && !catalogoError()" class="space-y-3" data-testid="sugerencias-productos">
                <div *ngIf="productosSugeridos().length === 0" class="p-4 border border-dashed border-gray-200 rounded-xl text-sm text-gray-500">
                    No hay resultados para tu búsqueda. Intenta con otro término.
                </div>
                <div *ngFor="let producto of productosSugeridos()" class="flex items-center justify-between gap-3 border rounded-2xl p-4 hover:border-blue-200 transition">
                    <div>
                        <p class="font-semibold text-gray-900">{{ producto.nombre }}</p>
                        <p class="text-sm text-gray-500">Código {{ producto.codigo }} • Stock {{ producto.stockActual }}</p>
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0">
                        <span class="font-bold text-lg text-gray-900">{{ producto.precioUnitario | currency:'CRC':'symbol-narrow':'1.2-2' }}</span>
                        <button
                            class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"
                            type="button"
                            [disabled]="producto.stockActual === 0"
                            (click)="seleccionarProducto(producto)"
                        >
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
        </article>

        <article class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Productos seleccionados</h2>
                    <p class="text-sm text-gray-500">Administra cantidades y precios antes de registrar la venta.</p>
                </div>
                <span class="text-sm text-gray-500">{{ resumen().articulos }} artículos</span>
            </div>

            <div *ngIf="lineas().length === 0" class="p-6 border border-dashed border-gray-200 rounded-2xl text-center text-gray-500">
                Aún no has agregado productos al pedido.
            </div>

            <div *ngIf="lineas().length > 0" class="space-y-4">
                <div *ngFor="let linea of lineas(); trackBy: trackByLinea" class="border rounded-2xl p-4">
                    <div class="flex items-start justify-between gap-4 flex-wrap">
                        <div>
                            <p class="font-semibold text-gray-900">{{ linea.nombre }}</p>
                            <p class="text-sm text-gray-500">Código {{ linea.codigo }} • Stock {{ linea.stockActual }}</p>
                        </div>
                        <button type="button" class="text-sm text-red-600 hover:text-red-700" (click)="eliminarLinea(linea.id)">
                            Quitar
                        </button>
                    </div>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <label class="text-sm text-gray-500 space-y-1">
                            Cantidad
                            <input
                                type="number"
                                min="1"
                                class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                                [value]="linea.cantidad"
                                (input)="cambiarCantidad(linea.id, $any($event.target).value)"
                            >
                        </label>
                        <label class="text-sm text-gray-500 space-y-1">
                            Precio unitario
                            <input
                                type="number"
                                min="0"
                                step="0.01"
                                class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                                [value]="linea.precioUnitario"
                                (input)="cambiarPrecio(linea.id, $any($event.target).value)"
                            >
                        </label>
                        <div class="text-sm text-gray-500 flex flex-col justify-end">
                            <span>Subtotal</span>
                            <p class="text-lg font-semibold text-gray-900">{{ (linea.cantidad * linea.precioUnitario) | currency:'CRC':'symbol-narrow':'1.2-2' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </article>
    </section>

    <section class="bg-gray-50 rounded-2xl border border-gray-100 p-6 space-y-6">
        <div>
            <h2 class="text-2xl font-semibold text-gray-900">Resumen del pedido</h2>
            <p class="text-sm text-gray-500">Completa los datos del cliente para finalizar la venta.</p>
        </div>

        <div class="space-y-4">
            <div class="rounded-2xl border border-gray-200 bg-white p-4 space-y-3">
                <div class="flex items-center justify-between gap-2">
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Buscar cliente registrado</p>
                        <p class="text-xs text-gray-500">Selecciona un cliente existente para reutilizar su información.</p>
                    </div>
                    <button type="button" *ngIf="clienteSeleccionado()" class="text-xs font-semibold text-red-600 hover:text-red-700" (click)="limpiarClienteSeleccion()">
                        Quitar selección
                    </button>
                </div>
                <input type="search" placeholder="Nombre, correo o teléfono" class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100" [value]="clienteFiltro()" (input)="actualizarFiltroCliente($any($event.target).value)">
                <div *ngIf="clientesLoading()" class="text-sm text-gray-500">Cargando clientes registrados…</div>
                <div *ngIf="!clientesLoading() && clientesError()" class="text-sm text-red-600">{{ clientesError() }}</div>
                <div *ngIf="!clientesLoading() && !clientesError()" class="space-y-2 max-h-48 overflow-y-auto" data-testid="sugerencias-clientes">
                    <button *ngFor="let item of clientesSugeridos()" type="button" class="w-full text-left border border-gray-200 rounded-xl px-4 py-2 text-sm hover:border-blue-300" (click)="seleccionarCliente(item)">
                        <p class="font-semibold text-gray-900">{{ item.nombre }}</p>
                        <p class="text-xs text-gray-500">{{ item.correo }} • {{ item.telefono || 'Sin teléfono' }}</p>
                    </button>
                    <p *ngIf="!clientesSugeridos().length" class="text-xs text-gray-500">No hay coincidencias para el término ingresado.</p>
                </div>
                <div *ngIf="clienteResumen() as info" class="rounded-xl border border-dashed border-gray-200 bg-gray-50 p-3 text-xs text-gray-600 space-y-1">
                    <p><span class="font-semibold text-gray-800">Categoría:</span> {{ info.categoria }}</p>
                    <p><span class="font-semibold text-gray-800">Correo:</span> {{ info.correo }}</p>
                    <p><span class="font-semibold text-gray-800">Teléfono:</span> {{ info.telefono }}</p>
                    <p>
                        <span class="font-semibold text-gray-800">Último mes:</span>
                        {{ info.compras }} compras • {{ info.monto | currency:'CRC':'symbol-narrow':'1.2-2' }}
                    </p>
                </div>
            </div>
            <label class="text-sm text-gray-600 space-y-1">
                Nombre del cliente
                <input type="text" class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Nombre del cliente" [value]="cliente()" (input)="actualizarCliente($any($event.target).value)">
            </label>
            <label class="text-sm text-gray-600 space-y-1">
                Método de pago
                <select class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100" [value]="metodoPago()" (change)="actualizarMetodoPago($any($event.target).value)">
                    <option *ngFor="let metodo of metodosPago" [value]="metodo">{{ metodo }}</option>
                </select>
            </label>
            <label class="text-sm text-gray-600 space-y-1">
                Vendedor
                <input type="text" class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Nombre del vendedor" [value]="vendedor()" (input)="actualizarVendedor($any($event.target).value)">
            </label>
            <label class="text-sm text-gray-600 space-y-1">
                Observaciones
                <textarea rows="3" class="w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Información adicional" [value]="observaciones()" (input)="actualizarObservaciones($any($event.target).value)"></textarea>
            </label>
        </div>

        <div class="space-y-3 border-t border-b border-gray-200 py-4">
            <div class="flex justify-between text-sm text-gray-600">
                <span>Artículos</span>
                <span>{{ resumen().articulos }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span>Subtotal</span>
                <span>{{ resumen().subtotal | currency:'CRC':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span>Impuestos (13%)</span>
                <span>{{ resumen().impuestos | currency:'CRC':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-xl font-semibold text-gray-900">
                <span>Total</span>
                <span>{{ resumen().total | currency:'CRC':'symbol-narrow':'1.2-2' }}</span>
            </div>
        </div>

        <button
            type="button"
            class="w-full rounded-2xl bg-green-600 text-white font-semibold py-3 hover:bg-green-700 disabled:opacity-60 disabled:cursor-not-allowed"
            [disabled]="!puedeRegistrar()"
            (click)="registrarVenta()"
        >
            {{ registrando() ? 'Registrando venta...' : 'Finalizar venta' }}
        </button>
        <p class="text-xs text-gray-500 text-center">Se enviará la información al backend para registrar la factura.</p>
    </section>
</div>