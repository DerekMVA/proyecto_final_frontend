<div class="p-8 space-y-6">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Control de Inventario</h1>
            <p class="text-sm text-gray-500">Mostrando {{ totalFiltrados() }} de {{ articulos().length }} productos</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button type="button"
                class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50"
                (click)="limpiarFiltros()" [disabled]="!hayFiltrosActivos()">
                Limpiar filtros
            </button>
            <button type="button"
                class="px-4 py-2 rounded-lg bg-gray-800 text-white font-semibold hover:bg-gray-900 disabled:opacity-50"
                (click)="refrescar()" [disabled]="loading()">
                {{ loading() ? 'Actualizando…' : 'Refrescar' }}
            </button>
            <a routerLink="/inventario/ajuste"
                class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">
                Registrar ajuste
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
            <p class="text-sm text-gray-500">Productos registrados</p>
            <p class="text-2xl font-semibold text-gray-900">{{ resumen().total }}</p>
        </div>
        <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
            <p class="text-sm text-gray-500">Stock total</p>
            <p class="text-2xl font-semibold text-gray-900">{{ resumen().stockTotal }}</p>
        </div>
        <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
            <p class="text-sm text-gray-500">Bajo stock</p>
            <p class="text-2xl font-semibold text-amber-600">{{ resumen().criticos }}</p>
        </div>
        <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
            <p class="text-sm text-gray-500">Sin stock</p>
            <p class="text-2xl font-semibold text-red-600">{{ resumen().sinStock }}</p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow border border-gray-100">
        <div class="p-6 grid grid-cols-1 xl:grid-cols-4 gap-4">
            <label class="flex flex-col gap-1 text-sm text-gray-700">
                <span>Buscar</span>
                <input type="search"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-gray-200"
                    placeholder="Nombre, código o categoría" [value]="termino()"
                    (input)="actualizarTermino($any($event.target).value)" />
            </label>

            <label class="flex flex-col gap-1 text-sm text-gray-700">
                <span>Categoría</span>
                <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-gray-200"
                    [value]="categoria()" (change)="actualizarCategoria($any($event.target).value)">
                    <option value="todas">Todas</option>
                    <option *ngFor="let categoria of categorias()" [value]="categoria">{{ categoria }}</option>
                </select>
            </label>

            <label class="flex flex-col gap-1 text-sm text-gray-700">
                <span>Estado</span>
                <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-gray-200"
                    [value]="estado()" (change)="actualizarEstado($any($event.target).value)">
                    <option value="todos">Todos</option>
                    <option *ngFor="let estado of estados()" [value]="estado">{{ estado }}</option>
                </select>
            </label>

            <label class="flex flex-col gap-1 text-sm text-gray-700">
                <span>Ordenar por</span>
                <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-gray-200"
                    [value]="orden()" (change)="actualizarOrden($any($event.target).value)">
                    <option value="nombre-asc">Nombre (A-Z)</option>
                    <option value="stock-desc">Stock (alto a bajo)</option>
                    <option value="stock-asc">Stock (bajo a alto)</option>
                    <option value="actualizado-desc">Actualizados recientemente</option>
                </select>
            </label>
        </div>

        <div *ngIf="loading()" class="px-6 py-8 text-center text-gray-500 border-t border-gray-100">
            Cargando inventario…
        </div>

        <div *ngIf="!loading() && error()" class="px-6 py-8 text-center text-red-600 border-t border-gray-100">
            {{ error() }}
        </div>

        <ng-container *ngIf="!loading() && !error()">
            <div *ngIf="totalFiltrados(); else sinResultados" class="overflow-x-auto border-t border-gray-100">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-4 text-left">Código</th>
                            <th class="p-4 text-left">Nombre</th>
                            <th class="p-4 text-left">Categoría</th>
                            <th class="p-4 text-center">Stock</th>
                            <th class="p-4 text-center">Estado</th>
                            <th class="p-4 text-right">Precio</th>
                            <th class="p-4 text-center">Actualizado</th>
                            <th class="p-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let articulo of articulosProcesados(); trackBy: trackByArticulo"
                            class="border-b last:border-b-0 hover:bg-gray-50">
                            <td class="p-4 text-sm text-gray-600">{{ articulo.codigo }}</td>
                            <td class="p-4 font-medium text-gray-900">
                                {{ articulo.nombre }}
                                <span *ngIf="articulo.ubicacion" class="block text-xs text-gray-500">{{ articulo.ubicacion }}</span>
                            </td>
                            <td class="p-4 text-sm text-gray-600">{{ articulo.categoria }}</td>
                            <td class="p-4 text-center">
                                <span
                                    class="inline-flex items-center justify-center px-2 py-1 rounded-full text-xs font-semibold"
                                    [class.bg-green-100]="articulo.stockActual > (articulo.stockMinimo ?? 0)"
                                    [class.text-green-800]="articulo.stockActual > (articulo.stockMinimo ?? 0)"
                                    [class.bg-amber-100]="articulo.stockActual <= (articulo.stockMinimo ?? 0) && articulo.stockActual > 0"
                                    [class.text-amber-800]="articulo.stockActual <= (articulo.stockMinimo ?? 0) && articulo.stockActual > 0"
                                    [class.bg-red-100]="articulo.stockActual <= 0"
                                    [class.text-red-800]="articulo.stockActual <= 0">
                                    {{ articulo.stockActual }}
                                </span>
                            </td>
                            <td class="p-4 text-center">
                                <span class="px-2 py-1 rounded-full text-xs"
                                    [class.bg-gray-200]="!articulo.estado"
                                    [class.text-gray-700]="!articulo.estado"
                                    [class.bg-blue-100]="articulo.estado"
                                    [class.text-blue-800]="articulo.estado">
                                    {{ articulo.estado || 'Sin estado' }}
                                </span>
                            </td>
                            <td class="p-4 text-right font-semibold text-gray-900">
                                {{ articulo.precioUnitario | currency:'CRC':'symbol-narrow':'1.2-2' }}
                            </td>
                            <td class="p-4 text-center text-sm text-gray-500">
                                {{ articulo.actualizado ? (articulo.actualizado | date:'dd/MM/yyyy HH:mm') : '—' }}
                            </td>
                            <td class="p-4 text-center">
                                <a [routerLink]="['/inventario/detalle', articulo.id]"
                                    class="text-blue-600 hover:underline text-sm font-semibold">
                                    Ver detalle
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </ng-container>
    </div>

    <ng-template #sinResultados>
        <div class="px-6 py-10 text-center text-gray-500">
            No se encontraron productos para los filtros seleccionados.
        </div>
    </ng-template>
</div>